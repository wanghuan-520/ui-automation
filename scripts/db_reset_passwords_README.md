# æ•°æ®åº“ç›´æ¥é‡ç½®å¯†ç è„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

`db_reset_passwords.py` è„šæœ¬å¯ä»¥ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œé‡ç½®è´¦å·æ± ä¸­è´¦å·çš„å­—æ®µï¼ˆusernameã€emailã€passwordï¼‰ã€‚

**æ”¯æŒçš„é‡ç½®ç±»å‹ï¼š**
- âœ… **å¯†ç é‡ç½®**ï¼šå°†å¯†ç é‡ç½®ä¸ºåˆå§‹å¯†ç ï¼ˆ`TestPass123!`ï¼‰
- âœ… **ç”¨æˆ·åé‡ç½®**ï¼šå°†ç”¨æˆ·åé‡ç½®ä¸ºè´¦å·æ± ä¸­çš„åŸå§‹å€¼
- âœ… **é‚®ç®±é‡ç½®**ï¼šå°†é‚®ç®±é‡ç½®ä¸ºè´¦å·æ± ä¸­çš„åŸå§‹å€¼
- âœ… **ç»„åˆé‡ç½®**ï¼šå¯ä»¥åŒæ—¶é‡ç½®å¤šä¸ªå­—æ®µï¼ˆå¦‚ username + emailï¼Œæˆ–æ‰€æœ‰å­—æ®µï¼‰

**ä¼˜åŠ¿ï¼š**
- âœ… ç»•è¿‡APIé™åˆ¶ï¼Œæ›´å¿«ã€æ›´å¯é 
- âœ… æ‰¹é‡é‡ç½®ï¼Œæ•ˆç‡é«˜
- âœ… ä¸ä¾èµ–APIå¯ç”¨æ€§
- âœ… æ”¯æŒçµæ´»çš„é‡ç½®ç­–ç•¥ï¼ˆæ ¹æ®æµ‹è¯•ä¿®æ”¹çš„å­—æ®µé€‰æ‹©é‡ç½®ï¼‰

## ğŸ”§ é…ç½®æ•°æ®åº“è¿æ¥

é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

```bash
# æ•°æ®åº“ç±»å‹ï¼ˆsqlserver, postgresql, mysqlï¼‰
export DB_TYPE=sqlserver

# æ•°æ®åº“è¿æ¥ä¿¡æ¯
export DB_HOST=localhost
export DB_PORT=1433  # SQL Serveré»˜è®¤1433, PostgreSQLé»˜è®¤5432, MySQLé»˜è®¤3306
export DB_NAME=AevatarStation
export DB_USER=sa
export DB_PASSWORD=your_password
```

## ğŸ“¦ å®‰è£…ä¾èµ–

æ ¹æ®æ•°æ®åº“ç±»å‹å®‰è£…å¯¹åº”çš„é©±åŠ¨ï¼š

### SQL Server
```bash
pip install pyodbc
```

### PostgreSQL
```bash
pip install psycopg2-binary
```

### MySQL
```bash
pip install pymysql
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æ‰¹é‡é‡ç½®æ‰€æœ‰è´¦å·

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export DB_TYPE=sqlserver
export DB_HOST=localhost
export DB_PORT=1433
export DB_NAME=AevatarStation
export DB_USER=sa
export DB_PASSWORD=your_password

# è¿è¡Œè„šæœ¬ï¼ˆé»˜è®¤é‡ç½®æ‰€æœ‰å­—æ®µï¼šusername, email, passwordï¼‰
python scripts/db_reset_passwords.py

# åªé‡ç½®å¯†ç 
python scripts/db_reset_passwords.py --fields password

# åªé‡ç½®ç”¨æˆ·åå’Œé‚®ç®±
python scripts/db_reset_passwords.py --fields username email

# é‡ç½®æ‰€æœ‰å­—æ®µï¼ˆæ˜¾å¼æŒ‡å®šï¼‰
python scripts/db_reset_passwords.py --fields username email password
```

### 2. åœ¨Pythonä»£ç ä¸­ä½¿ç”¨

```python
from scripts.db_reset_passwords import (
    reset_all_accounts,      # é‡ç½®æ‰€æœ‰è´¦å·ï¼ˆæ”¯æŒæŒ‡å®šå­—æ®µï¼‰
    reset_account_to_original,  # é‡ç½®å•ä¸ªè´¦å·ï¼ˆæ”¯æŒæŒ‡å®šå­—æ®µï¼‰
    reset_all_passwords,     # é‡ç½®æ‰€æœ‰è´¦å·çš„å¯†ç ï¼ˆå‘åå…¼å®¹ï¼‰
    reset_single_password,   # é‡ç½®å•ä¸ªè´¦å·çš„å¯†ç ï¼ˆå‘åå…¼å®¹ï¼‰
)

# ç¤ºä¾‹1: é‡ç½®æ‰€æœ‰è´¦å·çš„å¯†ç 
reset_all_passwords()

# ç¤ºä¾‹2: é‡ç½®æ‰€æœ‰è´¦å·çš„ç”¨æˆ·åå’Œé‚®ç®±ï¼ˆé€šå¸¸ä¸€èµ·ä¿®æ”¹ï¼‰
reset_all_accounts(["username", "email"])

# ç¤ºä¾‹3: é‡ç½®æ‰€æœ‰è´¦å·çš„æ‰€æœ‰å­—æ®µ
reset_all_accounts(["username", "email", "password"])

# ç¤ºä¾‹4: é‡ç½®å•ä¸ªè´¦å·çš„ç”¨æˆ·åå’Œé‚®ç®±
reset_account_to_original("qatest_v3__001", ["username", "email"])

# ç¤ºä¾‹5: é‡ç½®å•ä¸ªè´¦å·çš„å¯†ç 
reset_account_to_original("qatest_v3__001", ["password"])

# ç¤ºä¾‹6: é‡ç½®å•ä¸ªè´¦å·çš„æ‰€æœ‰å­—æ®µ
reset_account_to_original("qatest_v3__001")  # é»˜è®¤é‡ç½®æ‰€æœ‰å­—æ®µ
```

## ğŸ” å·¥ä½œåŸç†

### å¯†ç é‡ç½®
1. **è·å–å‚è€ƒå“ˆå¸Œ**ï¼šä»è´¦å·æ± ä¸­æ‰¾ä¸€ä¸ªå·²çŸ¥å¯†ç æ­£ç¡®çš„è´¦å·ï¼ŒæŸ¥è¯¢å…¶å¯†ç å“ˆå¸Œå€¼
2. **å¤åˆ¶å“ˆå¸Œ**ï¼šå°†å‚è€ƒè´¦å·çš„å¯†ç å“ˆå¸Œå¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰è´¦å·
3. **æ‰¹é‡æ›´æ–°**ï¼šä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰è´¦å·çš„å¯†ç å“ˆå¸Œ

**ä¸ºä»€ä¹ˆä½¿ç”¨å‚è€ƒå“ˆå¸Œï¼Ÿ**
- ABPæ¡†æ¶ä½¿ç”¨ASP.NET Core Identityçš„PasswordHasher
- å¯†ç å“ˆå¸Œç®—æ³•å¤æ‚ï¼ŒåŒ…å«saltå’Œè¿­ä»£æ¬¡æ•°
- ç›´æ¥å¤åˆ¶å·²çŸ¥æ­£ç¡®çš„å“ˆå¸Œå€¼æ˜¯æœ€å¯é çš„æ–¹æ³•

### ç”¨æˆ·å/é‚®ç®±é‡ç½®
1. **è¯»å–åŸå§‹é…ç½®**ï¼šä»è´¦å·æ± é…ç½®æ–‡ä»¶ä¸­è¯»å–è´¦å·çš„åŸå§‹ç”¨æˆ·åå’Œé‚®ç®±
2. **æ‰¹é‡æ›´æ–°**ï¼šå°†æ•°æ®åº“ä¸­çš„ç”¨æˆ·å/é‚®ç®±æ›´æ–°ä¸ºåŸå§‹å€¼

### ç»„åˆé‡ç½®
- å¯ä»¥åŒæ—¶é‡ç½®å¤šä¸ªå­—æ®µï¼ˆå¦‚ username + emailï¼‰
- æ ¹æ®æµ‹è¯•ä¿®æ”¹çš„å­—æ®µï¼Œé€‰æ‹©æ€§åœ°é‡ç½®ï¼Œæé«˜æ•ˆç‡

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“æƒé™**ï¼šç¡®ä¿æ•°æ®åº“ç”¨æˆ·æœ‰UPDATEæƒé™
2. **è¡¨åå’Œå­—æ®µå**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨å°è¯•ä¸åŒçš„è¡¨åå’Œå­—æ®µåç»„åˆ
   - è¡¨åï¼š`AspNetUsers`, `AbpUsers`, `Users`
   - å­—æ®µåï¼š`UserName`/`user_name`/`username`, `PasswordHash`/`password_hash`/`Password`
3. **å‚è€ƒè´¦å·**ï¼šç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè´¦å·çš„å¯†ç æ˜¯æ­£ç¡®çš„ï¼ˆ`TestPass123!`ï¼‰
4. **å¤‡ä»½**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®åº“

## ğŸ”„ ä¸APIé‡ç½®çš„å¯¹æ¯”

| ç‰¹æ€§ | æ•°æ®åº“é‡ç½® | APIé‡ç½® |
|------|-----------|---------|
| é€Ÿåº¦ | âš¡ æå¿« | ğŸŒ è¾ƒæ…¢ |
| å¯é æ€§ | âœ… é«˜ | âš ï¸ ä¾èµ–API |
| æƒé™è¦æ±‚ | æ•°æ®åº“æƒé™ | APIæƒé™ |
| é€‚ç”¨åœºæ™¯ | æ‰¹é‡é‡ç½® | å•ä¸ªé‡ç½® |

## ğŸ¯ é›†æˆåˆ°æµ‹è¯•æµç¨‹

### åœ¨pytest_sessionstartä¸­ä½¿ç”¨

ä¿®æ”¹ `tests/aevatar_station/conftest.py`ï¼š

```python
def pytest_sessionstart(session):
    if not hasattr(session.config, 'workerinput'):
        # ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“é‡ç½®ï¼ˆå¦‚æœé…ç½®äº†æ•°æ®åº“ï¼‰
        if os.getenv("DB_TYPE"):
            from scripts.db_reset_passwords import reset_all_passwords
            reset_all_passwords()
        else:
            # å›é€€åˆ°APIé‡ç½®
            import subprocess
            import sys
            script_path = Path(__file__).parent.parent.parent / "scripts" / "api_reset_passwords.py"
            subprocess.run([sys.executable, str(script_path)], check=True)
```

### åœ¨fixture teardownä¸­ä½¿ç”¨

```python
@pytest.fixture
def logged_in_page(page, request):
    # ... ç™»å½•é€»è¾‘ ...
    yield page
    
    # teardown: æ ¹æ®æµ‹è¯•ä¿®æ”¹çš„å­—æ®µé‡ç½®
    if hasattr(request.node, '_account_info'):
        username = request.node._account_info[0]
        if os.getenv("DB_TYPE"):
            from scripts.db_reset_passwords import reset_account_to_original
            
            # æ ¹æ®æµ‹è¯•ç±»å‹é€‰æ‹©é‡ç½®çš„å­—æ®µ
            # å¦‚æœæµ‹è¯•ä¿®æ”¹äº†usernameå’Œemailï¼Œé‡ç½®è¿™ä¸¤ä¸ªå­—æ®µ
            if request.node.get_closest_marker("modify_username_email"):
                reset_account_to_original(username, ["username", "email"])
            # å¦‚æœæµ‹è¯•ä¿®æ”¹äº†passwordï¼Œé‡ç½®å¯†ç 
            elif request.node.get_closest_marker("modify_password"):
                reset_account_to_original(username, ["password"])
            # é»˜è®¤é‡ç½®æ‰€æœ‰å­—æ®µ
            else:
                reset_account_to_original(username)
```

### åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­æ ‡è®°ä¿®æ”¹çš„å­—æ®µ

```python
@pytest.mark.modify_username_email
def test_update_profile(page):
    """æµ‹è¯•ä¿®æ”¹ç”¨æˆ·åå’Œé‚®ç®±"""
    # ... æµ‹è¯•é€»è¾‘ ...
    # teardownä¼šè‡ªåŠ¨é‡ç½®usernameå’Œemail

@pytest.mark.modify_password
def test_change_password(page):
    """æµ‹è¯•ä¿®æ”¹å¯†ç """
    # ... æµ‹è¯•é€»è¾‘ ...
    # teardownä¼šè‡ªåŠ¨é‡ç½®password
```

## ğŸ› æ•…éšœæ’æŸ¥

### 1. è¿æ¥å¤±è´¥
- æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥è¿æ¥ä¿¡æ¯æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 2. æ‰¾ä¸åˆ°è¡¨æˆ–å­—æ®µ
- æ£€æŸ¥è¡¨åæ˜¯å¦æ­£ç¡®ï¼ˆABPç‰ˆæœ¬ä¸åŒå¯èƒ½è¡¨åä¸åŒï¼‰
- æ£€æŸ¥å­—æ®µåæ˜¯å¦æ­£ç¡®
- å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹è„šæœ¬ä¸­çš„ `table_names` å’Œ `username_fields`ã€`password_fields` åˆ—è¡¨

### 3. æ— æ³•è·å–å‚è€ƒå“ˆå¸Œ
- ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè´¦å·çš„å¯†ç æ˜¯æ­£ç¡®çš„
- å¯ä»¥å…ˆè¿è¡Œ `api_reset_passwords.py` é‡ç½®ä¸€ä¸ªè´¦å·ï¼Œç„¶åå†è¿è¡Œæ•°æ®åº“é‡ç½®

## ğŸ“ ç¤ºä¾‹è¾“å‡º

### é‡ç½®æ‰€æœ‰å­—æ®µ
```
ğŸš€ å¼€å§‹æ•°æ®åº“ç›´æ¥é‡ç½®è´¦å·å­—æ®µ...
   æ•°æ®åº“ç±»å‹: sqlserver
   é‡ç½®å­—æ®µ: ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç 
--------------------------------------------------
   æ£€æµ‹è´¦å·: 20 ä¸ª
--------------------------------------------------
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
--------------------------------------------------
ğŸ“‹ ä½¿ç”¨å‚è€ƒè´¦å· qatest_v3__002 è·å–å¯†ç å“ˆå¸Œ...
âœ… è·å–åˆ°å¯†ç å“ˆå¸Œï¼ˆé•¿åº¦: 128ï¼‰
--------------------------------------------------
å¤„ç† qatest_v3__001... âœ…
å¤„ç† qatest_v3__002... âœ…
...
--------------------------------------------------
ğŸ“Š é‡ç½®ç»“æœç»Ÿè®¡:
   âœ… æˆåŠŸ: 20 ä¸ª
   âŒ å¤±è´¥: 0 ä¸ª
--------------------------------------------------
ğŸ é‡ç½®å®Œæˆ
```

### åªé‡ç½®ç”¨æˆ·åå’Œé‚®ç®±
```
ğŸš€ å¼€å§‹æ•°æ®åº“ç›´æ¥é‡ç½®è´¦å·å­—æ®µ...
   æ•°æ®åº“ç±»å‹: sqlserver
   é‡ç½®å­—æ®µ: ç”¨æˆ·åã€é‚®ç®±
--------------------------------------------------
   æ£€æµ‹è´¦å·: 20 ä¸ª
--------------------------------------------------
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
--------------------------------------------------
å¤„ç† qatest_v3__001... âœ…
å¤„ç† qatest_v3__002... âœ…
...
--------------------------------------------------
ğŸ“Š é‡ç½®ç»“æœç»Ÿè®¡:
   âœ… æˆåŠŸ: 20 ä¸ª
   âŒ å¤±è´¥: 0 ä¸ª
--------------------------------------------------
ğŸ é‡ç½®å®Œæˆ
```

### åªé‡ç½®å¯†ç 
```
ğŸš€ å¼€å§‹æ•°æ®åº“ç›´æ¥é‡ç½®è´¦å·å­—æ®µ...
   æ•°æ®åº“ç±»å‹: sqlserver
   é‡ç½®å­—æ®µ: å¯†ç 
--------------------------------------------------
   æ£€æµ‹è´¦å·: 20 ä¸ª
--------------------------------------------------
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
--------------------------------------------------
ğŸ“‹ ä½¿ç”¨å‚è€ƒè´¦å· qatest_v3__002 è·å–å¯†ç å“ˆå¸Œ...
âœ… è·å–åˆ°å¯†ç å“ˆå¸Œï¼ˆé•¿åº¦: 128ï¼‰
--------------------------------------------------
å¤„ç† qatest_v3__001... âœ…
...
--------------------------------------------------
ğŸ“Š é‡ç½®ç»“æœç»Ÿè®¡:
   âœ… æˆåŠŸ: 20 ä¸ª
   âŒ å¤±è´¥: 0 ä¸ª
--------------------------------------------------
ğŸ é‡ç½®å®Œæˆ
```

